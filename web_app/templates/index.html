<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Sentiment</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #2a5298);
      color: white;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .chart-container {
      width: 1000px;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      margin-bottom: 40px;
    }
    #updateTime {
      margin-bottom: 20px;
      color: rgba(255,255,255,0.7);
    }
    h2 {
      margin-bottom: 10px;
      color: white;
    }
  </style>
</head>
<body>
  <h1>ðŸ“ˆ Dashboard Sentiment</h1>
  <div id="updateTime"></div>

  <!-- 1. Streaming Line Chart -->
  <h2>Trend Positive/Negative</h2>
  <div id="streamLine" class="chart-container"></div>

  <!-- 2. Grouped Column Chart -->
  <h2>Sentiment theo hÃ£ng</h2>
  <div id="batchGrouped" class="chart-container"></div>

  <!-- 3. Pie / Doughnut Chart -->
  <h2>Tá»•ng sentiment</h2>
  <div id="batchTotals" class="chart-container"></div>

  <!-- 4. Column 10 Windows -->
  <h2>Sentiment 10 cá»­a sá»• gáº§n nháº¥t</h2>
  <div id="streamLatest" class="chart-container"></div>

  <script>
    // ===== 1. Streaming Line Chart =====
    async function fetchStreamTrend() {
      try {
        const res = await fetch("/api/stream_trend");
        return await res.json();
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    const streamChart = Highcharts.chart('streamLine', {
      chart: { type: 'spline', backgroundColor: 'transparent', animation: false },
      title: { text: '' },
      xAxis: { categories: [], labels: { style: { color: 'rgba(255,255,255,0.7)' } } },
      yAxis: { min: 0, gridLineColor: 'rgba(255,255,255,0.1)', labels: { style: { color: 'rgba(255,255,255,0.7)' } } },
      legend: { itemStyle: { color: 'rgba(255,255,255,0.8)' } },
      credits: { enabled: false },
      plotOptions: { series: { lineWidth: 2, marker: { enabled: false }, animation: false } },
      series: [
        { name: 'Positive', data: [], color: '#00ff88' },
        { name: 'Negative', data: [], color: '#ff5555' }
      ]
    });

    async function updateStreamChart() {
      const data = await fetchStreamTrend();
      if (!data) return;

      streamChart.xAxis[0].setCategories(data.labels, false);
      streamChart.series[0].setData(data.datasets[0].data, false);
      streamChart.series[1].setData(data.datasets[1].data, false);
      streamChart.redraw();

      document.getElementById("updateTime").textContent =
        "Cáº­p nháº­t lÃºc " + new Date().toLocaleTimeString("vi-VN");
    }

    updateStreamChart();
    setInterval(updateStreamChart, 5000);

    // ===== 2. Grouped Column Chart =====
    async function fetchBatchGrouped() {
      const res = await fetch("/api/batch_grouped");
      return await res.json();
    }

    async function renderBatchGrouped() {
      const data = await fetchBatchGrouped();
      Highcharts.chart('batchGrouped', {
        chart: { type: 'column', backgroundColor: 'transparent' },
        title: { text: '' },
        xAxis: { categories: data.labels, labels: { style: { color: 'rgba(255,255,255,0.7)' } } },
        yAxis: { min: 0, title: { text: 'Sá»‘ lÆ°á»£ng tweet' }, labels: { style: { color: 'rgba(255,255,255,0.7)' } } },
        legend: { itemStyle: { color: 'rgba(255,255,255,0.8)' } },
        plotOptions: { column: { stacking: 'normal' } },
        series: data.datasets.map(ds => ({
          name: ds.label,
          data: ds.data,
          color: ds.backgroundColor
        }))
      });
    }

    renderBatchGrouped();

    // ===== 3. Pie / Doughnut Chart =====
    async function renderBatchTotals() {
      const res = await fetch("/api/batch_totals");
      const data = await res.json();

      if (!data || !data.datasets || !data.datasets[0]) {
        console.error("Lá»—i dá»¯ liá»‡u batch_totals:", data);
        return;
      }

      const seriesData = (data.datasets[0].data || []).map((v, i) => ({
        name: data.labels?.[i] || `Label ${i}`,
        y: Number(v) || 0,
        color: data.datasets[0].backgroundColor?.[i] || '#888'
      }));

        Highcharts.chart('batchTotals', {
        chart: { 
          type: 'pie',
          backgroundColor: 'transparent'
        },
        title: { text: '' },
        plotOptions: {
          pie: {
            innerSize: '60%',
            borderWidth: 2,
            borderColor: 'rgba(255,255,255,0.1)',
            dataLabels: {
              enabled: true,
              color: '#fff',
              style: { textOutline: 'none', fontSize: '14px', fontWeight: '500' },
              format: '{point.name}<br>{point.y} ({point.percentage:.1f}%)'
            },
            states: {
              hover: { brightness: 0.1 }
            }
          }
        },
        tooltip: {
          pointFormat: '<b>{point.y}</b> tweet ({point.percentage:.1f}%)'
        },
        legend: {
          itemStyle: { color: 'rgba(255,255,255,0.8)' }
        },
        series: [{
          name: data.datasets[0].label,
          data: seriesData
        }]
      });

    }

    renderBatchTotals();

    // ===== 4. Column 10 Windows =====
    async function fetchStreamLatest() {
      const res = await fetch("/api/stream_latest_windows");
      return await res.json();
    }

    async function renderStreamLatest() {
      const data = await fetchStreamLatest();
      Highcharts.chart('streamLatest', {
        chart: { type: 'column', backgroundColor: 'transparent' },
        title: { text: '' },
        xAxis: { categories: data.labels, labels: { style: { color: 'rgba(255,255,255,0.7)' } } },
        yAxis: { min: 0, title: { text: 'Sá»‘ lÆ°á»£ng tweet' }, labels: { style: { color: 'rgba(255,255,255,0.7)' } } },
        legend: { enabled: false },
        series: [{
          name: data.datasets[0].label,
          data: data.datasets[0].data,
          color: undefined,
          colors: data.datasets[0].backgroundColor
        }]
      });
    }

    renderStreamLatest();
  </script>
</body>
</html>
